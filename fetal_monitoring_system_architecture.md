# АРХИТЕКТУРА СИСТЕМЫ ФЕТАЛЬНОГО МОНИТОРИНГА
## Описание для дизайнеров и архитекторов

---

## ОБЩЕЕ ОПИСАНИЕ СИСТЕМЫ

Система фетального мониторинга представляет собой комплексное решение для анализа состояния плода в реальном времени на основе данных кардиотокографии (КТГ) и сократительной активности матки. Система включает в себя компоненты машинного обучения, API для работы в реальном времени, базу данных и веб-интерфейс для визуализации.

### Основные цели системы:
- Мониторинг состояния плода в реальном времени
- Автоматическая диагностика патологий беременности
- Предоставление рекомендаций медицинскому персоналу
- Визуализация данных КТГ и сократительной активности матки
- Хранение и анализ исторических данных пациенток

---

## АРХИТЕКТУРНЫЕ КОМПОНЕНТЫ

### 1. СИСТЕМА МАШИННОГО ОБУЧЕНИЯ

#### 1.1 Модель классификации (FetalMLPredictor)
- **Назначение**: Классификация состояния плода на 3 класса (Normal, Suspect, Pathological)
- **Алгоритм**: Random Forest Classifier (лучшая модель по AUC)
- **Входные данные**: 21 параметр фетального мониторинга
- **Выходные данные**: Предсказание класса с вероятностями и уровнем уверенности

#### 1.2 Диагностическая система (FetalHealthAnalyzer)
- **Назначение**: Постановка медицинских диагнозов на основе талагоний
- **Алгоритм**: Правила на основе медицинских критериев
- **Диагнозы**:
  - Гипоксия плода (брадикардия, тахикардия, децелерации)
  - Дистресс плода (аномальная вариабельность)
  - Асфиксия плода (отсутствие ускорений и движений)
  - Плацентарная недостаточность (низкая вариабельность)
  - Угроза преждевременных родов (сократительная активность)
  - Подозрение на ЗВУР (сниженная реактивность)

### 2. API СЛОЙ (FastAPI)

#### 2.1 Realtime API (realtime_api.py)
- **Порт**: 8080
- **Протокол**: HTTP/HTTPS
- **Формат данных**: JSON, NDJSON, Server-Sent Events

#### 2.2 Основные эндпоинты:
- `GET /health` - проверка состояния сервиса
- `GET /sample` - единичный сэмпл данных КТГ
- `GET /stream/ndjson` - непрерывный поток данных (NDJSON)
- `GET /stream/sse` - поток Server-Sent Events
- `GET /viewer` - встроенный веб-интерфейс
- `POST /patients` - создание записи пациентки
- `GET /patients/{id}` - получение данных пациентки
- `POST /patients/{id}/record` - добавление записи измерения
- `POST /patients/{id}/records` - добавление пакета записей

### 3. СИМУЛЯТОР ДАННЫХ (CTGSimulator)

#### 3.1 Генерация данных КТГ
- **Частота сердечных сокращений (FHR)**:
  - Базальная частота: 80-170 уд/мин
  - Вариабельность: 0-30 уд/мин
  - Акселерации: +10-25 уд/мин, 15-30 сек
  - Децелерации: -10-30 уд/мин, 10-25 сек

#### 3.2 Генерация данных сократительной активности
- **Тонус матки (UC)**:
  - Базовый тонус: 10 мм рт.ст.
  - Пиковый тонус: 60 мм рт.ст.
  - Период схваток: 120 сек
  - Детекция тахисистолии: >5 пиков

#### 3.3 Влияние препаратов
- **Гинипрал**: снижение амплитуды схваток, возможная тахикардия
- **Магнезия**: снижение тонуса и вариабельности
- **Окситоцин**: усиление схваток

### 4. БАЗА ДАННЫХ (MongoDB)

#### 4.1 Коллекции
- **patients**: данные пациенток
  - _id (ObjectId)
  - full_name (string)
  - medications (array)
  - created_at (datetime)

- **records**: записи измерений
  - _id (ObjectId)
  - patient_id (ObjectId)
  - timestamp (datetime)
  - t_ms (int)
  - fhr_bpm (int)
  - uc_mmHg (float)

#### 4.2 Индексы
- patients.full_name
- records.patient_id + records.t_ms

### 5. СИСТЕМА ПРЕДСКАЗАНИЙ В РЕАЛЬНОМ ВРЕМЕНИ

#### 5.1 RealtimeFetalPredictor
- **Функции**:
  - Предсказание состояния плода
  - Генерация рекомендаций
  - Создание предупреждений
  - Ведение истории предсказаний

#### 5.2 DataEmulator
- **Функции**:
  - Генерация тестовых данных
  - Эмуляция потока данных
  - Добавление шума для реалистичности

---

## ПОТОКИ ДАННЫХ

### 1. ПОТОК ОБУЧЕНИЯ МОДЕЛИ
```
CSV данные → Загрузка → Предобработка → Разделение train/test → 
Обучение моделей → Валидация → Выбор лучшей модели → Сохранение
```

### 2. ПОТОК РЕАЛЬНОГО ВРЕМЕНИ
```
Симулятор → Генерация данных → API → Предсказание → 
Рекомендации → Предупреждения → База данных → Веб-интерфейс
```

### 3. ПОТОК ДИАГНОСТИКИ
```
Данные пациента → Анализ параметров → Применение правил → 
Постановка диагноза → Оценка тяжести → Генерация рекомендаций
```

---

## АЛГОРИТМЫ И МОДЕЛИ

### 1. МОДЕЛЬ КЛАССИФИКАЦИИ

#### 1.1 Random Forest Classifier
- **Параметры**: n_estimators=100, random_state=42
- **Метрики качества**: Accuracy, AUC-ROC
- **Предобработка**: StandardScaler для нормализации

#### 1.2 Альтернативные модели
- Gradient Boosting Classifier
- Logistic Regression
- Support Vector Machine

### 2. ДИАГНОСТИЧЕСКИЕ ПРАВИЛА

#### 2.1 Гипоксия плода
```
Критерии:
- Брадикардия (базовый ритм < 110 уд/мин)
- Тахикардия (базовый ритм > 160 уд/мин)
- Выраженные децелерации (> 0.01)
- Пролонгированные децелерации (> 0.005)
- Отсутствие ускорений (< 0.001)

Диагноз: >= 2 критерия
```

#### 2.2 Дистресс плода
```
Критерии:
- Аномальная краткосрочная вариабельность (> 70%)
- Аномальная долгосрочная вариабельность (> 30% времени)
- Критически низкая краткосрочная вариабельность (< 0.5)
- Критически низкая долгосрочная вариабельность (< 3)

Диагноз: >= 2 критерия
```

### 3. СИМУЛЯЦИЯ ДАННЫХ

#### 3.1 Генерация FHR
```
FHR = baseline + drift + noise + accel/decel + medication_effects
где:
- baseline: базовая частота (80-170 уд/мин)
- drift: медленный дрейф ±2 уд/мин
- noise: гауссов шум с вариабельностью
- accel/decel: эпизодические события
- medication_effects: влияние препаратов
```

#### 3.2 Генерация UC
```
UC = base + wave + noise + medication_effects
где:
- base: базовый тонус (10 мм рт.ст.)
- wave: синусоидальная волна (0-60 мм рт.ст.)
- noise: белый шум
- medication_effects: влияние препаратов
```

---

## ТЕХНОЛОГИЧЕСКИЙ СТЕК

### 1. BACKEND
- **Python 3.12**
- **FastAPI** - веб-фреймворк
- **Uvicorn** - ASGI сервер
- **Pydantic** - валидация данных
- **Motor** - асинхронный MongoDB драйвер

### 2. МАШИННОЕ ОБУЧЕНИЕ
- **scikit-learn** - алгоритмы ML
- **pandas** - работа с данными
- **numpy** - численные вычисления
- **joblib** - сериализация моделей

### 3. ВИЗУАЛИЗАЦИЯ
- **matplotlib** - статические графики
- **seaborn** - статистические графики
- **plotly** - интерактивные графики

### 4. БАЗА ДАННЫХ
- **MongoDB 6** - NoSQL база данных

### 5. КОНТЕЙНЕРИЗАЦИЯ
- **Docker** - контейнеризация
- **Docker Compose** - оркестрация

---

## СХЕМА РАЗВЕРТЫВАНИЯ

### 1. ЛОКАЛЬНОЕ РАЗВЕРТЫВАНИЕ
```
1. Установка зависимостей: pip install -r requirements.txt
2. Запуск MongoDB: mongod
3. Запуск API: python realtime_api.py
4. Доступ: http://localhost:8080
```

### 2. DOCKER РАЗВЕРТЫВАНИЕ
```
1. Сборка: docker compose build
2. Запуск: docker compose up -d
3. Доступ: http://localhost:8081
```

### 3. ПРОИЗВОДСТВЕННОЕ РАЗВЕРТЫВАНИЕ
```
1. Установка Docker на Ubuntu
2. Клонирование репозитория
3. Настройка переменных окружения
4. Запуск: docker compose up -d --build
```

---

## ИНТЕГРАЦИОННЫЕ ТОЧКИ

### 1. ВНЕШНИЕ СИСТЕМЫ
- **Медицинские устройства КТГ** - через API эндпоинты
- **Госпитальные информационные системы** - через REST API
- **Системы уведомлений** - через webhook'и

### 2. ВНУТРЕННИЕ ИНТЕРФЕЙСЫ
- **Веб-интерфейс** - через Server-Sent Events
- **Мобильные приложения** - через REST API
- **Системы аналитики** - через экспорт данных

---

## МОНИТОРИНГ И ЛОГИРОВАНИЕ

### 1. МЕТРИКИ ПРОИЗВОДИТЕЛЬНОСТИ
- Время отклика API
- Точность предсказаний
- Использование ресурсов
- Доступность сервиса

### 2. ЛОГИРОВАНИЕ
- Предсказания и их результаты
- Ошибки и исключения
- Доступ к API
- Изменения в базе данных

### 3. АЛЕРТЫ
- Критические состояния плода
- Ошибки в работе системы
- Превышение пороговых значений
- Проблемы с подключением к БД

---

## БЕЗОПАСНОСТЬ

### 1. АУТЕНТИФИКАЦИЯ
- JWT токены для API доступа
- Роли пользователей (врач, медсестра, администратор)

### 2. АВТОРИЗАЦИЯ
- Контроль доступа к данным пациенток
- Аудит действий пользователей

### 3. ЗАЩИТА ДАННЫХ
- Шифрование данных в БД
- HTTPS для всех соединений
- Валидация входных данных

---

## МАСШТАБИРУЕМОСТЬ

### 1. ГОРИЗОНТАЛЬНОЕ МАСШТАБИРОВАНИЕ
- Балансировка нагрузки между экземплярами API
- Шардирование MongoDB
- Кэширование часто используемых данных

### 2. ВЕРТИКАЛЬНОЕ МАСШТАБИРОВАНИЕ
- Увеличение ресурсов серверов
- Оптимизация запросов к БД
- Использование более мощных моделей ML

---

## ПЛАНЫ РАЗВИТИЯ

### 1. КРАТКОСРОЧНЫЕ (3-6 месяцев)
- Добавление новых диагностических правил
- Улучшение точности моделей ML
- Расширение веб-интерфейса

### 2. СРЕДНЕСРОЧНЫЕ (6-12 месяцев)
- Интеграция с медицинскими устройствами
- Мобильное приложение
- Система уведомлений

### 3. ДОЛГОСРОЧНЫЕ (1-2 года)
- ИИ для прогнозирования осложнений
- Интеграция с другими медицинскими системами
- Мультимодальный анализ данных

---

## ЗАКЛЮЧЕНИЕ

Система фетального мониторинга представляет собой комплексное решение, объединяющее современные технологии машинного обучения, веб-разработки и медицинской диагностики. Архитектура системы обеспечивает высокую производительность, масштабируемость и надежность, необходимые для работы в медицинских учреждениях.

Ключевые преимущества системы:
- Автоматизация диагностики патологий беременности
- Работа в реальном времени
- Интуитивный веб-интерфейс
- Гибкая архитектура для расширения функциональности
- Соответствие медицинским стандартам

Система готова к развертыванию и может быть адаптирована под конкретные требования медицинских учреждений.
