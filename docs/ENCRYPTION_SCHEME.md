# 🔐 СХЕМА СИСТЕМЫ ШИФРОВАНИЯ ТОКЕНОВ

## 📊 Диаграмма системы шифрования

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           СИСТЕМА ШИФРОВАНИЯ ТОКЕНОВ                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   СОЗДАНИЕ      │    │   ГЕНЕРАЦИЯ     │    │   ХРАНЕНИЕ      │
│   ПАЦИЕНТА      │    │   ТОКЕНОВ       │    │   В БД          │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 1. СОЗДАНИЕ ПАЦИЕНТА                                                           │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │   Пациент       │    │   Генерация     │    │   Сохранение    │              │
│ │   "Иванова А.П."│───▶│   monitoringToken│───▶│   в БД пациентов│              │
│ │   ID: 12345     │    │   (случайный)   │    │   + patientTokenHash│          │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 2. ГЕНЕРАЦИЯ ХЭШЕЙ                                                              │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │ monitoringToken │    │   PATIENT_SALT  │    │ patientTokenHash│              │
│ │ (случайный)     │───▶│   (секретный)   │───▶│ = sha256(token +│              │
│ │                 │    │                 │    │   PATIENT_SALT) │              │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│          │                                                                     │
│          ▼                                                                     │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │ monitoringToken │    │ MONITORING_SALT │    │monitoringTokenHash│            │
│ │ (тот же)        │───▶│   (секретный)   │───▶│ = sha256(token +│              │
│ │                 │    │                 │    │ MONITORING_SALT)│              │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 3. ХРАНЕНИЕ В РАЗНЫХ БД                                                         │
│ ┌─────────────────┐                    ┌─────────────────┐                      │
│ │   БД ПАЦИЕНТОВ  │                    │  БД МОНИТОРИНГА │                      │
│ │ ┌─────────────┐ │                    │ ┌─────────────┐ │                      │
│ │ │ patient_id  │ │                    │ │ session_id  │ │                      │
│ │ │ patientTokenHash│                  │ │ monitoringTokenHash│                │
│ │ │ name        │ │                    │ │ start_time  │ │                      │
│ │ │ status      │ │                    │ │ end_time    │ │                      │
│ │ └─────────────┘ │                    │ │ status      │ │                      │
│ └─────────────────┘                    │ └─────────────┘ │                      │
└─────────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 4. СТАРТ СЕССИИ МОНИТОРИНГА                                                     │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │   Фетальный     │    │   Отправка      │    │   Шифрование    │              │
│ │   монитор       │───▶│   monitoringToken│───▶│   в monitoringTokenHash│       │
│ │                 │    │   (открытый)    │    │   + сохранение  │              │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 5. ПОИСК СЕССИЙ МОНИТОРИНГА                                                     │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │   Запрос по     │    │   Поиск по      │    │   Получение     │              │
│ │   patientTokenHash│───▶│   patientTokenHash│───▶│   всех сессий  │              │
│ │                 │    │   в БД пациентов│    │   мониторинга   │              │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 6. РОТАЦИЯ ТОКЕНОВ (ОПЦИОНАЛЬНО)                                                │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │   Генерация     │    │   Помечание     │    │   Остановка     │              │
│ │   нового токена │───▶│   старого как   │───▶│   доступа по    │              │
│ │                 │    │   неактивного   │    │   старому токену│              │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔐 Детальная схема процесса

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ПРОЦЕСС ШИФРОВАНИЯ ТОКЕНОВ                            │
└─────────────────────────────────────────────────────────────────────────────────┘

1. СОЗДАНИЕ ПАЦИЕНТА
   ┌─────────────┐
   │ Пациент     │
   │ "Иванова"   │
   └─────┬───────┘
         │
         ▼
   ┌─────────────┐
   │ Генерация   │
   │ monitoringToken│
   │ (случайный) │
   └─────┬───────┘
         │
         ▼
   ┌─────────────┐
   │ Сохранение  │
   │ в БД        │
   └─────────────┘

2. ГЕНЕРАЦИЯ ХЭШЕЙ
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ monitoringToken│ + │ PATIENT_SALT│ = │ patientTokenHash│
   │ (открытый)  │    │ (секретный) │    │ (зашифрованный)│
   └─────────────┘    └─────────────┘    └─────────────┘
         │
         ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ monitoringToken│ + │MONITORING_SALT│ = │monitoringTokenHash│
   │ (тот же)    │    │ (секретный) │    │ (зашифрованный)│
   └─────────────┘    └─────────────┘    └─────────────┘

3. ХРАНЕНИЕ В БД
   ┌─────────────────┐                    ┌─────────────────┐
   │   БД ПАЦИЕНТОВ  │                    │  БД МОНИТОРИНГА │
   │ ┌─────────────┐ │                    │ ┌─────────────┐ │
   │ │ patient_id  │ │                    │ │ session_id  │ │
   │ │ patientTokenHash│                  │ │ monitoringTokenHash│
   │ │ name        │ │                    │ │ start_time  │ │
   │ │ status      │ │                    │ │ end_time    │ │
   │ └─────────────┘ │                    │ └─────────────┘ │
   └─────────────────┘                    └─────────────────┘

4. СТАРТ СЕССИИ
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ Фетальный   │───▶│ Отправка    │───▶│ Шифрование  │
   │ монитор     │    │ monitoringToken│    │ + сохранение│
   └─────────────┘    └─────────────┘    └─────────────┘

5. ПОИСК СЕССИЙ
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ Запрос по   │───▶│ Поиск по    │───▶│ Получение   │
   │ patientTokenHash│    │ patientTokenHash│    │ всех сессий│
   └─────────────┘    └─────────────┘    └─────────────┘

6. РОТАЦИЯ ТОКЕНОВ
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │ Генерация   │───▶│ Помечание   │───▶│ Остановка   │
   │ нового      │    │ старого как │    │ доступа     │
   │ токена      │    │ неактивного │    │ по старому  │
   └─────────────┘    └─────────────┘    └─────────────┘
```

## 🔑 Ключевые компоненты

### **Токены:**
- **monitoringToken** - открытый токен для мониторинга
- **patientTokenHash** - зашифрованный хэш для привязки к пациенту
- **monitoringTokenHash** - зашифрованный хэш для сессий мониторинга

### **Соли (Salt):**
- **PATIENT_SALT** - секретная соль для пациентов
- **MONITORING_SALT** - секретная соль для мониторинга

### **Базы данных:**
- **БД пациентов** - хранит patientTokenHash
- **БД мониторинга** - хранит monitoringTokenHash

### **Процессы:**
1. **Создание** - генерация токена и хэшей
2. **Хранение** - раздельное хранение в разных БД
3. **Мониторинг** - шифрование и сохранение сессий
4. **Поиск** - поиск сессий по patientTokenHash
5. **Ротация** - обновление токенов

---

**Версия**: 1.0  
**Дата**: 2024-01-15  
**Автор**: Команда разработки системы мониторинга КТГ
