# Фетальный мониторинг: что мы сделали и как это работает

## Цель
Сделать умный мониторинг КТГ, который помогает врачам быстро понять текущее состояние плода и увидеть риски вперёд на 10/30/60 минут. Всё это должно стабильно работать на обычном «железе» (ARM/x86, 4 ядра, 8 ГБ ОЗУ), рядом с нашим бэкендом и фронтендом.

## Какие данные используем
Мы работаем с таблицей признаков, полученных из КТГ (21 показатель). Это, например: базальный ритм, ускорения, сокращения матки, параметры вариабельности и гистограммы. Исторические данные использовали для обучения, а в реальном времени — для расчётов на лету.

## Что именно делает ML
1) Оценивает текущее состояние
- Выдаёт класс: Норма / Подозрение / Патология
- Показывает уверенность и вероятности по классам

2) Прогнозирует риски вперёд (10/30/60 минут)
- Вероятности: брадикардии, тахикардии, сниженной вариабельности, тахисистолии матки, а также общий риск «любая патология»
- Прогноз строится по «окну» последних минут сигнала (скользящее окно с агрегатами)

## Почему такие модели
- Табличные признаки из КТГ хорошо решаются «лёгкими» алгоритмами (градиентный бустинг, случайный лес): быстро, надёжно, понятно.
- Для прогноза вместо сложных временных нейросетей используем простые и понятные агрегаты окна (средние, разбросы, доли событий). Это устойчиво и хорошо работает на небольших устройствах.

## Как устроена работа в реальном времени
- Для каждого пациента идёт поток данных (SSE). Каждые ~100 мс приходят новые значения.
- ML встраивается в поток и добавляет блок с оценкой текущего состояния и прогнозами.
- Чтобы не перегружать устройство, ML-расчёт идёт примерно 2 раза в секунду (между обновлениями повторяем последнее значение).

## Совместимость с «железом» (edge)
- По умолчанию используем классические модели в формате PKL (sklearn). Это просто и надёжно.
- При необходимости можем переключиться на ONNX Runtime с 8-битной квантизацией — это ускоряет расчёты без заметной потери качества и не требует смены кода потоков.
- При наличии специализированного железа (NPU/GPU) есть пути к дополнительному ускорению.

## Что уже готово
- Обученные модели для текущего состояния и прогнозов на 10/30/60 минут.
- Потоки с интегрированным ML (для пациентов 001–002 — включены; можно расширять на остальных).
- Диагностика: отдельный эндпоинт показывает, используется ли PKL или ONNX, и какие прогнозные модели подключены.

## Что получает врач в интерфейсе
- Текущая оценка («Норма/Подозрение/Патология») + уверенность
- Вероятности по диагнозам на горизонтах 10/30/60 минут (как только накопится несколько минут данных)
- Вся информация обновляется автоматически в реальном времени

## Почему это важно
- Важен не только «снимок» текущего состояния, но и взгляд вперёд: так легче вовремя заметить риск и принять решение.
- Простые и прозрачные модели легче проверять, объяснять и поддерживать.
- Решение рассчитано на работу рядом с оборудованием, без «облака», что снижает задержки и риски.

## Что дальше
- Включить ML для остальных потоков, как только подтвердим стабильную нагрузку.
- При необходимости — ускорить инференс (ONNX INT8) и добавить «ранние» прогнозы по укороченному окну для самых первых минут наблюдения.
- Настроить пороги и визуальные сигналы под требования врачей.
