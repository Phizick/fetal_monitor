# ÐÐ²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ñ‹Ð¹ Dockerfile Ð±ÐµÐ· Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1

WORKDIR /app

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python 3.12 Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    curl \
    wget \
    gnupg \
    build-essential \
    nginx \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y python3.12 python3.12-pip python3.12-dev \
    && ln -s /usr/bin/python3.12 /usr/bin/python \
    && ln -s /usr/bin/pip3 /usr/bin/pip \
    && rm -rf /var/lib/apt/lists/*

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js 18
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° MongoDB
RUN wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | apt-key add - \
    && echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list \
    && apt-get update \
    && apt-get install -y mongodb-org \
    && rm -rf /var/lib/apt/lists/*

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
COPY . .

# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci --only=production
COPY frontend/ ./
RUN npm run build

# ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
WORKDIR /app
RUN mv frontend/build ./frontend_build

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx
RUN echo 'server {\n\
    listen 80;\n\
    server_name localhost;\n\
    \n\
    location / {\n\
        root /app/frontend_build;\n\
        index index.html;\n\
        try_files $uri $uri/ /index.html;\n\
    }\n\
    \n\
    location ~ ^/(patients|monitoring|stream|sim|health|docs|openapi\\.json) {\n\
        proxy_pass http://localhost:8081$request_uri;\n\
        proxy_set_header Host $host;\n\
        proxy_set_header X-Real-IP $remote_addr;\n\
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\
        proxy_set_header X-Forwarded-Proto $scheme;\n\
    }\n\
}' > /etc/nginx/sites-available/default

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
ENV HOST=0.0.0.0 \
    PORT=8081 \
    MONGO_URI=mongodb://localhost:27017 \
    MONGO_DB=fetal \
    TELEGRAM_BOT_TOKEN=8231116636:AAEzm1aDfPAo1yXY4Zmv6pjekIqnokk3afs

EXPOSE 80 8081

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°
RUN echo '#!/bin/bash\n\
echo "ðŸ¥ Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÐšÐ¢Ð“..."\n\
\n\
echo "ðŸ—„ï¸  Ð—Ð°Ð¿ÑƒÑÐº MongoDB..."\n\
mongod --fork --logpath /var/log/mongodb.log --dbpath /var/lib/mongodb\n\
echo "âœ… MongoDB Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"\n\
\n\
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº API ÑÐµÑ€Ð²ÐµÑ€Ð°..."\n\
uvicorn realtime_api:app --host ${HOST:-0.0.0.0} --port ${PORT:-8081} &\n\
API_PID=$!\n\
echo "âœ… API ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (PID: $API_PID)"\n\
\n\
echo "ðŸŒ Ð—Ð°Ð¿ÑƒÑÐº Nginx Ð´Ð»Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°..."\n\
nginx -g "daemon off;" &\n\
NGINX_PID=$!\n\
echo "âœ… Nginx Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (PID: $NGINX_PID)"\n\
\n\
echo "ðŸ¤– Ð—Ð°Ð¿ÑƒÑÐº Telegram Ð±Ð¾Ñ‚Ð°..."\n\
python -c "\n\
import asyncio\n\
from telegram_bot import telegram_bot, notification_system\n\
\n\
async def run_bot():\n\
    print(\"âœ… Telegram Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!\")\n\
    while True:\n\
        await asyncio.sleep(60)\n\
\n\
asyncio.run(run_bot())\n\
" &\n\
BOT_PID=$!\n\
echo "âœ… Telegram Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (PID: $BOT_PID)"\n\
\n\
echo "=" * 50\n\
echo "âœ… Ð’Ð¡Ð• Ð¡Ð•Ð Ð’Ð˜Ð¡Ð« Ð—ÐÐŸÐ£Ð©Ð•ÐÐ«!"\n\
echo "=" * 50\n\
echo "ðŸŒ Frontend: http://localhost"\n\
echo "ðŸ”§ API ÑÐµÑ€Ð²ÐµÑ€: http://localhost:8081"\n\
echo "ðŸ“Š Swagger UI: http://localhost:8081/docs"\n\
echo "ðŸ¤– Telegram Ð±Ð¾Ñ‚: Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½"\n\
echo "=" * 50\n\
\n\
# Cleanup function\n\
cleanup() {\n\
    echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."\n\
    kill $API_PID $NGINX_PID $BOT_PID 2>/dev/null\n\
    mongod --shutdown 2>/dev/null\n\
    exit 0\n\
}\n\
\n\
# Signal handling\n\
trap cleanup SIGTERM SIGINT\n\
\n\
# Wait\n\
wait\n\
' > /app/start.sh && chmod +x /app/start.sh

CMD ["/app/start.sh"]
