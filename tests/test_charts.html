<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–ª–∞–≤–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ - Fetal Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0b1220 0%, #1a1a2e 100%);
            color: #e6edf3;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #4ade80, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 20px 0;
        }
        
        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ef4444;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background-color: #4ade80;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }
        
        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #d1d5db;
        }
        
        .control-group input, .control-group select {
            padding: 6px 10px;
            border: 1px solid #374151;
            border-radius: 6px;
            background: #111827;
            color: #e6edf3;
            font-size: 12px;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.1);
        }
        
        .control-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4ade80;
        }
        
        .chart-container {
            background: linear-gradient(135deg, #0b1220 0%, #1a1a2e 100%);
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(31, 41, 55, 0.5);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 400px;
        }
        
        .chart-wrapper {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 16px;
            position: relative;
        }
        
        .chart-title {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: bold;
            color: #e6edf3;
        }
        
        .chart-canvas {
            height: calc(100% - 40px);
        }
        
        .info-panel {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background: #0b1220;
            border-radius: 6px;
            border: 1px solid #374151;
        }
        
        .info-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: bold;
            color: #e6edf3;
        }
        
        .pathology-alert {
            background: #7f1d1d;
            color: #fecaca;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            font-size: 12px;
            font-weight: bold;
        }
        
        .medication-info {
            background: #1f2937;
            color: #9ca3af;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .button-primary {
            background: #4ade80;
            color: #0b1220;
        }
        
        .button-primary:hover {
            background: #22c55e;
        }
        
        .button-secondary {
            background: #6b7280;
            color: white;
        }
        
        .button-secondary:hover {
            background: #4b5563;
        }
        
        .button-danger {
            background: #ef4444;
            color: white;
        }
        
        .button-danger:hover {
            background: #dc2626;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ –¢–µ—Å—Ç –ø–ª–∞–≤–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤</h1>
            <p>Fetal Monitoring - Real-time CTG/UC Charts</p>
        </div>
        
        <div class="status">
            <div class="status-indicator">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...</span>
            </div>
            <div id="connection-info">
                <span>API: <strong>http://localhost:8081</strong></span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>API URL:</label>
                <input type="text" id="api-url" value="http://localhost:8081" placeholder="http://localhost:8081">
            </div>
            
            <div class="control-group">
                <label>–û–∫–Ω–æ –¥–∞–Ω–Ω—ã—Ö (—Å–µ–∫):</label>
                <input type="number" id="window-size" value="15" min="5" max="60">
            </div>
            
            <div class="control-group">
                <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–º—Å):</label>
                <input type="number" id="update-interval" value="100" min="50" max="1000">
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enable-smoothing" checked>
                    –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
                </label>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="show-pathology" checked>
                    –ü–∞—Ç–æ–ª–æ–≥–∏–∏
                </label>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="show-medications" checked>
                    –ü—Ä–µ–ø–∞—Ä–∞—Ç—ã
                </label>
            </div>
            
            <div class="control-group">
                <button id="connect-btn" class="button button-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            </div>
            
            <div class="control-group">
                <button id="disconnect-btn" class="button button-danger">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="info-panel">
            <h3 style="margin: 0 0 15px 0; color: #e6edf3;">üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">FHR (—É–¥/–º–∏–Ω)</div>
                    <div id="fhr-value" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">UC (–º–º —Ä—Ç.—Å—Ç.)</div>
                    <div id="uc-value" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ë–∞–∑–æ–≤—ã–π —Ä–∏—Ç–º</div>
                    <div id="baseline-value" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–í–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</div>
                    <div id="variability-value" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ê–∫—Å–µ–ª–µ—Ä–∞—Ü–∏–∏</div>
                    <div id="accel-value" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–î–µ—Ü–µ–ª–µ—Ä–∞—Ü–∏–∏</div>
                    <div id="decel-value" class="info-value">--</div>
                </div>
            </div>
            
            <div id="pathology-info" style="margin-top: 15px;"></div>
            <div id="medication-info" style="margin-top: 10px;"></div>
        </div>
        
        <div class="chart-container">
            <div class="charts-grid">
                <div class="chart-wrapper">
                    <h3 class="chart-title">üìà FHR (—É–¥/–º–∏–Ω)</h3>
                    <div class="chart-canvas">
                        <canvas id="fhr-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-wrapper">
                    <h3 class="chart-title">üìä UC (–º–º —Ä—Ç.—Å—Ç.)</h3>
                    <div class="chart-canvas">
                        <canvas id="uc-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; color: #9ca3af; font-size: 12px;">
            <p>üí° –ì—Ä–∞—Ñ–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Server-Sent Events</p>
            <p>üîß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—à–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let charts = {};
        let eventSource = null;
        let isConnected = false;
        let data = {
            fhr: [],
            uc: [],
            pathologies: [],
            medications: []
        };
        let startTime = null;
        let windowSize = 15;
        let updateInterval = 100;
        let enableSmoothing = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Chart.js
        function initCharts() {
            // FHR –≥—Ä–∞—Ñ–∏–∫
            const fhrCtx = document.getElementById('fhr-chart').getContext('2d');
            charts.fhr = new Chart(fhrCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'FHR (—É–¥/–º–∏–Ω)',
                        data: [],
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        fill: true,
                        tension: enableSmoothing ? 0.4 : 0,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                title: (context) => {
                                    const time = new Date(context[0].parsed.x);
                                    return `–í—Ä–µ–º—è: ${time.toLocaleTimeString()}`;
                                },
                                label: (context) => {
                                    return `FHR: ${context.parsed.y.toFixed(1)} —É–¥/–º–∏–Ω`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            title: {
                                display: true,
                                text: '–í—Ä–µ–º—è',
                                color: '#e6edf3',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e6edf3', maxTicksLimit: 8 }
                        },
                        y: {
                            min: 60,
                            max: 200,
                            title: {
                                display: true,
                                text: 'FHR (—É–¥/–º–∏–Ω)',
                                color: '#e6edf3',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e6edf3' }
                        }
                    },
                    animation: { duration: 0 }
                }
            });

            // UC –≥—Ä–∞—Ñ–∏–∫
            const ucCtx = document.getElementById('uc-chart').getContext('2d');
            charts.uc = new Chart(ucCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'UC (–º–º —Ä—Ç.—Å—Ç.)',
                        data: [],
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        fill: true,
                        tension: enableSmoothing ? 0.4 : 0,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                title: (context) => {
                                    const time = new Date(context[0].parsed.x);
                                    return `–í—Ä–µ–º—è: ${time.toLocaleTimeString()}`;
                                },
                                label: (context) => {
                                    return `UC: ${context.parsed.y.toFixed(1)} –º–º —Ä—Ç.—Å—Ç.`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            title: {
                                display: true,
                                text: '–í—Ä–µ–º—è',
                                color: '#e6edf3',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e6edf3', maxTicksLimit: 8 }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'UC (–º–º —Ä—Ç.—Å—Ç.)',
                                color: '#e6edf3',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e6edf3' }
                        }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function updateData(newData) {
            const now = Date.now();
            const windowMs = windowSize * 1000;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            const newFhrPoint = { x: now, y: newData.fhr_bpm };
            const newUcPoint = { x: now, y: newData.uc_mmHg };
            
            data.fhr.push(newFhrPoint);
            data.uc.push(newUcPoint);
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ)
            data.fhr = data.fhr.filter(point => now - point.x <= windowMs);
            data.uc = data.uc.filter(point => now - point.x <= windowMs);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            charts.fhr.data.datasets[0].data = data.fhr;
            charts.uc.data.datasets[0].data = data.uc;
            
            charts.fhr.update('none');
            charts.uc.update('none');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            updateInfo(newData);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateInfo(data) {
            document.getElementById('fhr-value').textContent = data.fhr_bpm;
            document.getElementById('uc-value').textContent = data.uc_mmHg.toFixed(1);
            document.getElementById('baseline-value').textContent = data.baseline_bpm;
            document.getElementById('variability-value').textContent = data.variability_bpm.toFixed(1);
            document.getElementById('accel-value').textContent = data.accel ? '–î–∞' : '–ù–µ—Ç';
            document.getElementById('decel-value').textContent = data.decel ? '–î–∞' : '–ù–µ—Ç';
            
            // –ü–∞—Ç–æ–ª–æ–≥–∏–∏
            const pathologyDiv = document.getElementById('pathology-info');
            if (data.pathology) {
                pathologyDiv.innerHTML = `
                    <div class="pathology-alert">
                        ‚ö†Ô∏è ${data.pathology_desc || '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–∞—Ç–æ–ª–æ–≥–∏—è'}
                    </div>
                `;
            } else {
                pathologyDiv.innerHTML = '';
            }
            
            // –ü—Ä–µ–ø–∞—Ä–∞—Ç—ã
            const medicationDiv = document.getElementById('medication-info');
            if (data.medications && data.medications.length > 0) {
                medicationDiv.innerHTML = `
                    <div class="medication-info">
                        üíä –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã: ${data.medications.join(', ')}
                    </div>
                `;
            } else {
                medicationDiv.innerHTML = '';
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
        function connectToAPI() {
            if (eventSource) {
                eventSource.close();
            }
            
            const apiUrl = document.getElementById('api-url').value;
            eventSource = new EventSource(`${apiUrl}/stream/sse`);
            
            eventSource.onopen = () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –ø–æ—Ç–æ–∫—É –¥–∞–Ω–Ω—ã—Ö');
                isConnected = true;
                startTime = Date.now();
                updateStatus();
            };
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateData(data);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', error);
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                isConnected = false;
                updateStatus();
                
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (!isConnected) {
                        connectToAPI();
                    }
                }, 5000);
            };
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç API
        function disconnectFromAPI() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isConnected = false;
            updateStatus();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus() {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (isConnected) {
                dot.classList.add('connected');
                text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ API';
            } else {
                dot.classList.remove('connected');
                text.textContent = '–ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function updateSettings() {
            windowSize = parseInt(document.getElementById('window-size').value);
            updateInterval = parseInt(document.getElementById('update-interval').value);
            enableSmoothing = document.getElementById('enable-smoothing').checked;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            charts.fhr.options.elements.line.tension = enableSmoothing ? 0.4 : 0;
            charts.uc.options.elements.line.tension = enableSmoothing ? 0.4 : 0;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('connect-btn').addEventListener('click', () => {
                updateSettings();
                connectToAPI();
            });
            
            document.getElementById('disconnect-btn').addEventListener('click', disconnectFromAPI);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                connectToAPI();
            }, 1000);
        });
    </script>
</body>
</html>
