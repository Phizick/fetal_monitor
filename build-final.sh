#!/bin/bash

echo "üèóÔ∏è  –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–ë–û–†–ö–ê –ü–†–û–ï–ö–¢–ê –î–õ–Ø ARM64"
echo "========================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "Dockerfile" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω."
    exit 1
fi

# –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê DOCKER
echo "üßπ –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê DOCKER..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker stop $(docker ps -aq) 2>/dev/null || true

# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker rm $(docker ps -aq) 2>/dev/null || true

# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤..."
docker rmi $(docker images -aq) 2>/dev/null || true

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã Docker
echo "üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker —Å–∏—Å—Ç–µ–º—ã..."
docker system prune -a -f --volumes

# –û—á–∏—Å—Ç–∫–∞ buildx –∫–µ—à–∞
echo "üßπ –û—á–∏—Å—Ç–∫–∞ buildx –∫–µ—à–∞..."
docker buildx prune -a -f 2>/dev/null || true

echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# –°–ë–û–†–ö–ê –û–ë–†–ê–ó–ê
echo "üî® –°–ë–û–†–ö–ê –û–ë–†–ê–ó–ê –î–õ–Ø ARM64..."

# –ü—Ä–æ—Å—Ç–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ buildx
docker build --platform linux/arm64 -t fetal-app:arm64 . --no-cache

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    
    # –ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
    echo "üöÄ –ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–û–í..."
    docker-compose up -d
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        
        # –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫—É–Ω–¥)..."
        sleep 30
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        echo "üìä –°–¢–ê–¢–£–° –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:"
        docker-compose ps
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
        echo "üîç –ü–†–û–í–ï–†–ö–ê API..."
        if curl -f http://localhost:8081/health >/dev/null 2>&1; then
            echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç: http://localhost:8081"
        else
            echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
        echo "üîç –ü–†–û–í–ï–†–ö–ê FRONTEND..."
        if curl -f http://localhost/ >/dev/null 2>&1; then
            echo "‚úÖ Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç: http://localhost"
        else
            echo "‚ùå Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
        fi
        
        echo ""
        echo "=================================================="
        echo "‚úÖ –ü–†–û–ï–ö–¢ –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù!"
        echo "=================================================="
        echo "üåê Frontend: http://localhost"
        echo "üîß API: http://localhost:8081"
        echo "üìä Swagger: http://localhost:8081/docs"
        echo "üìã –õ–æ–≥–∏: docker-compose logs -f"
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: docker-compose down"
        echo "=================================================="
        
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤!"
        echo "üìã –õ–æ–≥–∏ –æ—à–∏–±–æ–∫:"
        docker-compose logs
        exit 1
    fi
    
else
    echo "‚ùå –û–®–ò–ë–ö–ê –ü–†–ò –°–ë–û–†–ö–ï –û–ë–†–ê–ó–ê!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã."
    exit 1
fi
